<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  
  <meta name="description" content="分享前端开发中的技术文章，分享生活中的灵感与创意，旅行心得等。">
  

  <!--Author-->
  
  <meta name="author" content="Zilia">
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="移动端-图片压缩上传实践"/>
  
  <!--Open Graph Description-->
  
      <meta property="og:description" content="分享前端开发中的技术文章，分享生活中的灵感与创意，旅行心得等。" />
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="舍宠博客"/>
  <!--Type page-->
  
      <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Title -->
  
  <title>移动端-图片压缩上传实践 - 舍宠博客</title>


  <link rel="shortcut icon" href="https://hexo.io/icon/favicon-96x96.png">

  <!-- Custom CSS/Sass -->
  <link rel="stylesheet" href="/css/style.css">

  <!----------------------------
  https://github.com/GallenHu/hexo-theme-Daily

 _____            _   _
|  __ \          (_) | |
| |  | |   __ _   _  | |  _   _
| |  | |  / _` | | | | | | | | |
| |__| | | (_| | | | | | | |_| |
|_____/   \__,_| |_| |_|  \__, |
                          __/ |
                         |___/

    --------------------------->

</head>


<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    <div class="logo">
      <a href="/" rel="home">
        
        <img src="https://shuangmuyingzi.github.io/img/logo.jpg" alt="舍宠博客" height="60">
        
      </a>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  Home
                
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  Archive
                
              </a>
            </li>
          
            <li>
              <a href="/about">
                
                  About
                
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
  <div class="post">
    <!-- Post Content -->
    <div class="container">
      <article>
        <!-- Title date & tags -->
        <div class="post-header">
          <h1 class="entry-title">
            移动端-图片压缩上传实践
            
          </h1>
          <p class="posted-on">
          2018-08-27
          </p>
          <div class="tags-links">
            
              
                <a href="/tags/js/" rel="tag">
                  js
                </a>
              
            
          </div>
        </div>
        <!-- Post Main Content -->
        <div class="entry-content ">
          <p>本文主要讲解移动端的图片压缩上传，在移动端压缩图片并且上传主要用到filereader、canvas 以及 formdata 这三个h5的api。</p>
<a id="more"></a>
<p>在做移动端图片上传的时候，用户传的都是手机本地图片，而本地图片一般都相对比较大，拿iphone6来说，平时拍很多图片都是一两M的，如果直接这样上传，那图片就太大了，如果用户用的是移动流量，完全把图片上传显然不是一个好办法。</p>
<p>　　目前来说，HTML5的各种新API都在移动端的webkit上得到了较好的实现。根据查看caniuse，本demo里使用到的FileReader、Blob、Formdata对象均已在大部分移动设备浏览器中得到了实现（safari6.0+、android 3.0+），所以直接在前端压缩图片，已经成了很多移动端图片上传的必备功能了。</p>
<p>　　在移动端压缩图片并且上传主要用到filereader、canvas 以及 formdata 这三个h5的api。逻辑并不难。整个过程就是：</p>
<p>　　（1）用户使用input file上传图片的时候，用filereader读取用户上传的图片数据（base64格式）</p>
<p>　　（2）把图片数据传入img对象，然后将img绘制到canvas上，再调用canvas.toDataURL对图片进行压缩</p>
<p>　　（3）获取到压缩后的base64格式图片数据，转成二进制塞入formdata，再通过XmlHttpRequest提交formdata。</p>
<p>　　如此三步，就完成了图片的压缩和上传。</p>
<p>　　说起来好像挺简单，其实还是有些坑的。接下来就直接用代码进行分析：
　　</p>
<h3 id="获取图片数据"><a href="#获取图片数据" class="headerlink" title="获取图片数据"></a>获取图片数据</h3><p>先是获取图片数据，也就是监听input file的change事件，然后获取到上传的文件对象files，如果是多张图需将类数组的files转成数组，然后进行forEach遍历。</p>
<p>　　接着判断文件类型，如果不是图片则不作处理。如果是图片就实例化一个filereader，以base64格式读取上传的文件数据，判断数据长度，如果大于3M的图片就调用compress方法进行压缩，否则调用upload方法进行上传。　</p>
<pre><code>// 上传图片回显到本地并且判断超过3M走压缩否则直接上传到服务器
choosePhoto:function(event){

            var that = this;
            var target = event.currentTarget;
            var file = target.files[0];

            // 判断图片的类型大小
            var imgType = /\.jpg|\.png|\.jpeg/i;
            if( !imgType.test(file.name) ){
                this.layer(&quot;只支持图片上传，请选择正确的图片格式&quot;);
                return;
            }
            // 利用fileReader 预览图片
            if( typeof FileReader ==&quot;underfined&quot; )  {
                this.layer(&quot;您的浏览器不支持图片预览功能，请换浏览器重试&quot;);

            }else{
                var reader = new FileReader();
                reader.onload = function(){
                    that.img.src = reader.result;
                        var img = new Image();
                    img.src = reader.result;
                    if((file.size/1024000)&gt;3){
                        var data = that.compress(img);
                        that.Upload2(data,file.type,idx);
                    }else{
                        that.Upload(target.files[0],idx);
                    } 
                    // input清空，防止两次请求同一个时不能选中
                    target.value = &apos;&apos;;
                }
                reader.readAsDataURL(file);
            }
        },
</code></pre><h3 id="压缩图片"><a href="#压缩图片" class="headerlink" title="压缩图片"></a>压缩图片</h3><p>上面做完图片数据的获取后，就可以做compress压缩图片的方法了。而压缩图片也并不是直接把图片绘制到canvas再调用一下toDataURL就行的。</p>
<p>　　在IOS中，canvas绘制图片是有两个限制的：</p>
<p>　　首先是图片的大小，如果图片的大小超过两百万像素，图片也是无法绘制到canvas上的，调用drawImage的时候不会报错，但是你用toDataURL获取图片数据的时候获取到的是空的图片数据。</p>
<p>　　再者就是canvas的大小有限制，如果canvas的大小大于大概五百万像素（即宽高乘积）的时候，不仅图片画不出来，其他什么东西也都是画不出来的。</p>
<p>　　应对第一种限制，处理办法就是瓦片绘制了。瓦片绘制，也就是将图片分割成多块绘制到canvas上，我代码里的做法是把图片分割成100万像素一块的大小，再绘制到canvas上。</p>
<p>　　而应对第二种限制，我的处理办法是对图片的宽高进行适当压缩，我代码里为了保险起见，设的上限是四百万像素，如果图片大于四百万像素就压缩到小于四百万像素。四百万像素的图片应该够了，算起来宽高都有2000X2000了。</p>
<p>　　如此一来就解决了IOS上的两种限制了。</p>
<p>　　除了上面所述的限制，还有两个坑，一个就是canvas的toDataURL是只能压缩jpg的，当用户上传的图片是png的话，就需要转成jpg，也就是统一用canvas.toDataURL(‘image/jpeg’, 0.1) ， 类型统一设成jpeg，而压缩比就自己控制了。</p>
<p>　　另一个就是如果是png转jpg，绘制到canvas上的时候，canvas存在透明区域的话，当转成jpg的时候透明区域会变成黑色，因为canvas的透明像素默认为rgba(0,0,0,0)，所以转成jpg就变成rgba(0,0,0,1)了，也就是透明背景会变成了黑色。解决办法就是绘制之前在canvas上铺一层白色的底色。
　　</p>
<p>   compress:function(img) {<br>    var canvas = document.createElement(“canvas”);<br>    var ctx = canvas.getContext(‘2d’);<br>    //瓦片canvas<br>    var tCanvas = document.createElement(“canvas”);<br>    var tctx = tCanvas.getContext(“2d”);<br>    var initSize = img.src.length;<br>    var width = img.width;<br>    var height = img.height;</p>
<pre><code>//如果图片大于四百万像素，计算压缩比并将大小压至400万以下
var ratio;
if ((ratio = width * height / 4000000)&gt;1) {
    ratio = Math.sqrt(ratio);
    width /= ratio;
    height /= ratio;
}else {
    ratio = 1;
}

canvas.width = width;
canvas.height = height;

// 铺底色
ctx.fillStyle = &quot;#fff&quot;;
ctx.fillRect(0, 0, canvas.width, canvas.height);

//如果图片像素大于100万则使用瓦片绘制
var count;
if ((count = width * height / 1000000) &gt; 1) {
    count = ~~(Math.sqrt(count)+1); //计算要分成多少块瓦片

    // 计算每块瓦片的宽和高
    var nw = ~~(width / count);
    var nh = ~~(height / count);

    tCanvas.width = nw;
    tCanvas.height = nh;

    for (var i = 0; i &lt; count; i++) {
        for (var j = 0; j &lt; count; j++) {
            tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);
            ctx.drawImage(tCanvas, i * nw, j * nh, nw, nh);
        }
    }
} else {
    ctx.drawImage(img, 0, 0, width, height);
}

//进行最小压缩
var ndata = canvas.toDataURL(&apos;image/jpeg&apos;, 0.1);

console.log(&apos;压缩前：&apos; + initSize);
console.log(&apos;压缩后：&apos; + ndata.length);
console.log(&apos;压缩率：&apos; + ~~(100 * (initSize - ndata.length) / initSize) + &quot;%&quot;);

tCanvas.width = tCanvas.height = canvas.width = canvas.height = 0;

return ndata;
</code></pre><p>}</p>
<h3 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a>图片上传</h3><p>完成图片压缩后，就可以塞进formdata里进行上传了，先将base64数据转成字符串，再实例化一个ArrayBuffer，然后将字符串以8位整型的格式传入ArrayBuffer，再通过BlobBuilder或者Blob对象，将8位整型的ArrayBuffer转成二进制对象blob，然后把blob对象append到formdata里，再通过ajax发送给后台即可。</p>
<p>getBlob:function(buffer, format) {<br>    try {<br>      return new Blob(buffer, {type: format});<br>    } catch (e) {<br>      var bb = new (window.BlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder);<br>      buffer.forEach(function(buf) {<br>        bb.append(buf);<br>      });<br>      return bb.getBlob(format);<br>    }<br>  },<br>            // 上传图片的ajax请求<br>            async Upload2(fileData,type,index){<br>                console.log(“执行了上传的第二个函数”);<br>                var text = window.atob(fileData.split(“,”)[1]);<br>    var buffer = new Uint8Array(text.length);<br>    var pecent = 0, loop = null;<br>    for (var i = 0; i &lt; text.length; i++) {<br>      buffer[i] = text.charCodeAt(i);<br>    }<br>    var blob = this.getBlob([buffer], type);<br>                let that = this;<br>                let form = new FormData();<br>                form.append(“Filedata”,blob);<br>                await myAjax.post( apiPath.upload ,form,{<br>                    ‘headers’:{<br>                        ‘mimeType’:’multipart/form-data’<br>                    }<br>                } ).then( res =&gt; {</p>
<pre><code>    } ).catch( e =&gt; {
    } );


},
// 上传图片的ajax请求
async Upload(fileData,index){
    let that = this;
    let form = new FormData();
    form.append(&quot;Filedata&quot;,fileData);
    await myAjax.post( apiPath.upload ,form,{
        &apos;headers&apos;:{
            &apos;mimeType&apos;:&apos;multipart/form-data&apos;
        }
    } ).then( res =&gt; {

    } ).catch( e =&gt; {
    } );

},
</code></pre><p>本文代码提供了大概的思路以及主要的代码，具体的demo自己动手做起来吧。这格式真的是见鬼了，凑合着看吧。</p>

        </div>
      </article>
    </div>
    <!-- Comments -->
    <div class="container">
      
<section id="comment">
  <!-- <h1 class="title">留言</h1> -->

  
  <div id="disqus_thread">
    <script type="text/javascript">
    var disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = 'post-imgUpload';
          this.page.title = '移动端-图片压缩上传实践';
      };
    </script>
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>


    </div>
    <!-- Pre or Next -->
    <div class="nav-links">
      
      
        <div class="nav-next">
          <a href="/2018/07/mobile/" rel="prev">下一页 <span class="meta-arraw meta-arraw-right"></span></a>
        </div>
      
    </div>

  </div>
</div>


  <!-- Footer -->
  <!-- Footer-widgets -->
<div class="footer-widgets">
  <div class="row inside-wrapper">
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">关于本站</h1>
        <div class="custom-widget-content">
          
          <p align="left">分享前端开发中的技术文章，分享生活中的灵感与创意，旅行心得等</p>
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">与我联系</h1>
        <div class="widget-text">
          
            
              <a href="https://github.com/shuangmuyingzi" class="icon icon-github" target="_blank">github</a>
            
              <a href="http://weibo.com/shuangmuyingzi" class="icon icon-weibo" target="_blank">weibo</a>
            
              <a href="mailto:466570690lzy@gmail.com" class="icon icon-mail" target="_blank">mail</a>
            
          
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">站内搜索</h1>
        <div class="widget-text">
          <form onSubmit="return appDaily.submitSearch('')">
            <p>
              <input type="text" placeholder="search..." id="homeSearchInput">
            </p>
            <!-- <input type="submit" value="GO"> -->
          </form>
        </div>
      </aside>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="site-info">
  <p>
    <span>舍宠博客 &copy; 2018</span>
    
      <span class="split">|</span>
      <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> with Theme <a href="https://github.com/GallenHu/hexo-theme-Daily" target="_blank">Daily</a></span>
    
  </p>
</footer>


  <!-- After footer scripts -->
  <!-- scripts -->
<script src="/js/app.js"></script>

<script>
  var disqus_shortname = 'hinpc';

  
  var disqus_url = 'https://shuangmuyingzi.github.io/2018/08/imgUpload/';
  

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>





</body>

</html>
